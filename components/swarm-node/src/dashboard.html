<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swarm Dashboard</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --accent: #3b82f6; --success: #22c55e; }
        body { background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; padding-bottom: 20px; margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card); padding: 20px; rounded: 8px; border-left: 4px solid var(--accent); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .card h3 { font-size: 0.75rem; text-transform: uppercase; color: #94a3b8; margin: 0 0 10px 0; }
        .card p { font-size: 2rem; font-family: monospace; margin: 0; }
        .deploy-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        section { background: var(--card); padding: 25px; border-radius: 8px; }
        .btn { background: var(--accent); color: white; border: none; padding: 12px; width: 100%; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .btn:disabled { opacity: 0.5; }
        #console { background: #000; padding: 15px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; color: #cbd5e1; border-radius: 4px; }
        .log-blue { color: #60a5fa; } .log-yellow { color: #facc15; } .log-green { color: #4ade80; } .log-red { color: #f87171; }
        .hidden { display: none; }
        .file-box { border: 2px dashed #475569; padding: 20px; text-align: center; cursor: pointer; border-radius: 8px; }
        @media (max-width: 768px) { .deploy-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1 style="margin:0; color:var(--accent)">Swarm Cluster</h1>
                <small style="color:#64748b">v0.6.1 Compute Runtime</small>
            </div>
            <div id="status-badge" style="background:#1e293b; padding:5px 15px; border-radius:20px; font-size:0.7rem; font-weight:bold; border:1px solid #334155">CONNECTING...</div>
        </header>

        <div class="grid">
            <div class="card"><h3>Connected Peers</h3><p id="peer-count">--</p></div>
            <div class="card" style="border-left-color: #a855f7"><h3>Node Role</h3><p id="node-role">GATEWAY</p></div>
            <div class="card" style="border-left-color: #eab308"><h3>Active Shard</h3><p>1</p></div>
        </div>

        <div class="deploy-grid">
            <section>
                <h2 style="margin-top:0">ðŸš€ Deploy Wasm</h2>
                <div class="file-box" onclick="document.getElementById('wasm-file').click()">
                    <input type="file" id="wasm-file" class="hidden" accept=".wasm">
                    <span id="file-name" style="color:#94a3b8">Select .wasm module</span>
                </div>
                <button id="deploy-btn" class="btn">Broadcast to Swarm</button>
            </section>
            <section style="background:#000">
                <h2 style="margin-top:0; font-size:0.9rem; color:var(--success)">EXECUTION_LOG</h2>
                <div id="console"> > System ready.</div>
            </section>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('wasm-file');
        const fileName = document.getElementById('file-name');
        const deployBtn = document.getElementById('deploy-btn');
        const consoleLog = document.getElementById('console');
        const badge = document.getElementById('status-badge');

        function log(msg, colorClass = '') {
            const p = document.createElement('div');
            p.className = colorClass;
            p.innerHTML = `&gt; ${new Date().toLocaleTimeString()}: ${msg}`;
            consoleLog.appendChild(p);
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }

        fileInput.onchange = (e) => { if(e.target.files[0]) fileName.innerText = e.target.files[0].name; };

        deployBtn.onclick = async () => {
            const file = fileInput.files[0];
            if(!file) return alert("Pick a file first!");
            deployBtn.disabled = true;
            log(`Reading ${file.name}...`, 'log-blue');

            const reader = new FileReader();
            reader.onload = async () => {
                const bytes = new Uint8Array(reader.result);
                const base64 = btoa(bytes.reduce((data, byte) => data + String.fromCharCode(byte), ''));
                log("Broadcasting to P2P mesh...", "log-yellow");
                try {
                    const res = await fetch('/deploy', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ wasm_base64: base64 })
                    });
                    const text = await res.text();
                    log(text, text.includes('SUCCESS') ? 'log-green' : 'log-red');
                } catch (e) { log("Error: " + e.message, 'log-red'); }
                finally { deployBtn.disabled = false; }
            };
            reader.readAsArrayBuffer(file);
        };

        async function update() {
            try {
                const res = await fetch('/status');
                const data = await res.json();
                document.getElementById('peer-count').innerText = data.peers_count;
                document.getElementById('node-role').innerText = data.role;
                badge.style.color = "#4ade80"; badge.innerText = "SYSTEM LIVE";
            } catch(e) { badge.style.color = "#f87171"; badge.innerText = "OFFLINE"; }
        }
        setInterval(update, 2000); update();
    </script>
</body>
</html>
